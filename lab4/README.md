# Лабораторная работа№4
___
Керпик Артём Витальевич Р33121

Вариант: 1312
___
## Задание:
Составить запросы на языке SQL (пункты 1-2).

Для каждого запроса предложить индексы, добавление которых уменьшит время выполнения запроса (указать таблицы/атрибуты, для которых нужно добавить индексы, написать тип индекса; объяснить, почему добавление индекса будет полезным для данного запроса).

Для запросов 1-2 необходимо составить возможные планы выполнения запросов. Планы составляются на основании предположения, что в таблицах отсутствуют индексы. Из составленных планов необходимо выбрать оптимальный и объяснить свой выбор.
Изменятся ли планы при добавлении индекса и как?

Для запросов 1-2 необходимо добавить в отчет вывод команды EXPLAIN ANALYZE [запрос]

Подробные ответы на все вышеперечисленные вопросы должны присутствовать в отчете (планы выполнения запросов должны быть нарисованы, ответы на вопросы - представлены в текстовом виде).
## Запросы:

Таблицы: Н_ТИПЫ_ВЕДОМОСТЕЙ, Н_ВЕДОМОСТИ. </br>
Вывести атрибуты: Н_ТИПЫ_ВЕДОМОСТЕЙ.ИД, Н_ВЕДОМОСТИ.ДАТА. </br>
Фильтры (AND): </br>
a) Н_ТИПЫ_ВЕДОМОСТЕЙ.ИД < 2. </br>
b) Н_ВЕДОМОСТИ.ИД > 1457443. </br>
Вид соединения: INNER JOIN. </br>

Таблицы: Н_ЛЮДИ, Н_ВЕДОМОСТИ, Н_СЕССИЯ. </br>
Вывести атрибуты: Н_ЛЮДИ.ОТЧЕСТВО, Н_ВЕДОМОСТИ.ДАТА, Н_СЕССИЯ.УЧГОД. </br>
Фильтры (AND): </br> 
a) Н_ЛЮДИ.ФАМИЛИЯ < Ёлкин. </br>
b) Н_ВЕДОМОСТИ.ДАТА < 1998-01-05. </br>
c) Н_СЕССИЯ.ДАТА > 2012-01-25. </br>
Вид соединения: LEFT JOIN. </br>
## Реализация

### Запрос№1
~~~
select
    "Н_ТИПЫ_ВЕДОМОСТЕЙ"."ИД", "Н_ВЕДОМОСТИ"."ДАТА"
from
    "Н_ТИПЫ_ВЕДОМОСТЕЙ"
inner join
        "Н_ВЕДОМОСТИ"
on
    "Н_ТИПЫ_ВЕДОМОСТЕЙ"."ИД" = "Н_ВЕДОМОСТИ"."ТВ_ИД"
where
        "Н_ТИПЫ_ВЕДОМОСТЕЙ"."ИД" < 2 AND "Н_ВЕДОМОСТИ"."ИД" > 1457443;
~~~

Возможные планы выполнения:

1. Выполнение inner join
2. Полное сканирование таблицы для условия Н_ТИПЫ_ВЕДОМОСТЕЙ.ИД < 2.
3. Полное сканирование таблицы для условия Н_ВЕДОМОСТИ.ИД > 1457443.
4. Выбор столбцов "Н_ТИПЫ_ВЕДОМОСТЕЙ"."ИД", "Н_ВЕДОМОСТИ"."ДАТА"

Рисунок

1. Полное сканирование таблицы Н_ТИПЫ_ВЕДОМОСТЕЙ для условия Н_ТИПЫ_ВЕДОМОСТЕЙ.ИД < 2.
2. Полное сканирование таблицы Н_ВЕДОМОСТИ для условия Н_ВЕДОМОСТИ.ИД > 1457443.
3. Выполнение inner join на результаты первых двух шагов
4. Выбор столбцов "Н_ТИПЫ_ВЕДОМОСТЕЙ"."ИД", "Н_ВЕДОМОСТИ"."ДАТА"

Рисунок

1. Полное сканирование таблицы Н_ТИПЫ_ВЕДОМОСТЕЙ для условия Н_ТИПЫ_ВЕДОМОСТЕЙ.ИД < 2.
2. Выбор "Н_ТИПЫ_ВЕДОМОСТЕЙ"."ИД"
3. Полное сканирование таблицы Н_ВЕДОМОСТИ для условия Н_ВЕДОМОСТИ.ИД > 1457443.
4. Выбор столбцов "Н_ВЕДОМОСТИ"."ДАТА", "Н_ВЕДОМОСТИ"."ТВ_ИД"
5. Выполнение inner join
6. Выбор столбцов "Н_ТИПЫ_ВЕДОМОСТЕЙ"."ИД", "Н_ВЕДОМОСТИ"."ДАТА"


![](https://github.com/thebordelie/bd/blob/main/lab4/img/plan1.png)

Самым оптимальным является последний способ выполнения, так как есть возможность реализовать конвеерную обработку данных, а также сведена к минимуму работа с промежуточными данными. 

**Вывод Explain**:

![](https://github.com/thebordelie/bd/blob/main/lab4/img/explain1.png)


#### Возможные индексы:

- Для таблицы Н_ТИПЫ_ВЕДОМОСТЕЙ:</br>
  Для стобца ИД можно использовать следующие виды индексов
  - **Hash**
  - **B-tree**
- Для таблицы Н_ВЕДОМОСТИ: </br>
  Для стобца ИД можно использовать следующие виды индексов
  - **Hash**
  - **B-tree**
___
### Запрос№2

~~~
SELECT "Н_ЛЮДИ"."ОТЧЕСТВО", "Н_ВЕДОМОСТИ"."ДАТА", "Н_СЕССИЯ"."УЧГОД"
FROM "Н_ЛЮДИ"
         LEFT JOIN "Н_ВЕДОМОСТИ" ON "Н_ЛЮДИ"."ИД" = "Н_ВЕДОМОСТИ"."ЧЛВК_ИД"
         LEFT JOIN "Н_СЕССИЯ" ON "Н_ЛЮДИ"."ИД" = "Н_СЕССИЯ"."ЧЛВК_ИД"
WHERE
      "Н_ЛЮДИ"."ФАМИЛИЯ" < 'Ёлкин' AND "Н_ВЕДОМОСТИ"."ДАТА" < '1998-01-05' AND "Н_СЕССИЯ"."ДАТА" > '2012-01-25' ; 
~~~

Возможные планы выполнения:

1. Выполнение LEFT JOIN для таблиц "Н_ВЕДОМОСТИ", "Н_ЛЮДИ"
2. Выполнение LEFT JOIN для таблицы  "Н_СЕССИЯ"
3. Выполнение всех фильтров
4. Вывод "Н_ЛЮДИ"."ОТЧЕСТВО", "Н_ВЕДОМОСТИ"."ДАТА", "Н_СЕССИЯ"."УЧГОД"

План№2

1. Для таблицы "Н_ЛЮДИ" выбрать строки где "Н_ЛЮДИ"."ФАМИЛИЯ" < 'Ёлкин'
2. Для таблицы "Н_ВЕДОМОСТИ" выбрать строки где "Н_ВЕДОМОСТИ"."ДАТА" < '1998-01-05'
3. left join для "Н_ЛЮДИ" и "Н_ВЕДОМОСТИ"
4. Для таблицы "Н_СЕССИЯ" выбрать строки где "Н_СЕССИЯ"."ДАТА" > '2012-01-25'
5.  left join для "Н_СЕССИЯ"
6.  Вывод "Н_ЛЮДИ"."ОТЧЕСТВО", "Н_ВЕДОМОСТИ"."ДАТА", "Н_СЕССИЯ"."УЧГОД"

План№3

1. Для таблицы "Н_ЛЮДИ" выбрать строки ФАМИЛИЯ и ИД
2. Для таблицы "Н_ВЕДОМОСТИ" выбрать строки ДАТА и ЧЛВК_ИД
3. Для таблицы "Н_ЛЮДИ" выбрать строки где "Н_ЛЮДИ"."ФАМИЛИЯ" < 'Ёлкин'
4. Для таблицы "Н_ВЕДОМОСТИ" выбрать строки где "Н_ВЕДОМОСТИ"."ДАТА" < '1998-01-05'
5. left join для "Н_ЛЮДИ" и "Н_ВЕДОМОСТИ"
6. Для таблицы "Н_СЕССИЯ" выбрать строки ДАТА и ЧЛВК_ИД
7. Для таблицы "Н_СЕССИЯ" выбрать строки где "Н_СЕССИЯ"."ДАТА" > '2012-01-25'
8. left join для "Н_СЕССИЯ"
9. Вывод "Н_ЛЮДИ"."ОТЧЕСТВО", "Н_ВЕДОМОСТИ"."ДАТА", "Н_СЕССИЯ"."УЧГОД"

![](https://github.com/thebordelie/bd/blob/main/lab4/img/plan2.png)

Оптимальным планом является последнми, так как на каждом шаге мы работаем с минимальным количеством промежуточных данных, возможность использовать конвеерную обработку данных, в этом плане используется левосторонний план. 

**Вывод Explain**:

![](https://github.com/thebordelie/bd/blob/main/lab4/img/explain2.png)
## Вывод:
В ходе выполнения лабораторной работы я основе выданных запросов разработал возможные планы выполнения, а также лучше познакомился с индексами и их влиянию на производительность
